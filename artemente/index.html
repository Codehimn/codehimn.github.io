<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Â¡Rifa Artemente: Conecta con tu EnergÃ­a Creativa!</title>
  <meta name="description" content="Rifa de un Kit Creativo-Consciente (camiseta, tula y sesiÃ³n de yoga). Participa: juega el 7 de noviembre de 2025 con las 2 Ãºltimas cifras de la LoterÃ­a de MedellÃ­n. Publicaremos el nÃºmero ganador aquÃ­." />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="wrap">
      <div class="info">
        <span class="tag">Â¡Conecta con tu EnergÃ­a Creativa!</span>
        <span class="sub">Juega el <b>7 de noviembre de 2025</b> con las <b>2 Ãºltimas cifras</b> de la LoterÃ­a de MedellÃ­n.</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <figure class="card">
        <img class="hero-img" src="artemente-rifa.jpg" alt="Kit Creativo Artemente en rifa" />
      </figure>

      <div class="grid-card card">
        <h1 class="title">GÃ¡nate este Kit Creativo-Consciente Artemente</h1>
        <p class="sub">El ganador se llevarÃ¡: <b>camiseta, tula y sesiÃ³n de yoga con meditaciÃ³n antiestrÃ©s</b>. Â¡Pocos cupos disponibles y mucha suerte! <b>Valor del nÃºmero: $10.000</b></p>
        
        <div class="legend" aria-hidden="true">
          <div class="legend-item"><span class="dot"></span> Disponible</div>
          <div class="legend-item"><span class="dot selected"></span> Seleccionado</div>
          <div class="legend-item"><span class="dot sold"></span> Reservado</div>
        </div>

        <div id="board" class="board" role="grid" aria-label="CuadrÃ­cula de la rifa (00 a 99)"></div>
        
        <div class="cta">
          <button id="btnWhats" class="btn ok">ğŸ“² Enviar SelecciÃ³n por WhatsApp</button>
          <button id="btnResetSelection" class="btn ghost" title="Limpiar nÃºmeros seleccionados">Limpiar SelecciÃ³n</button>
        </div>
        <p class="note">Publicaremos aquÃ­ el <b>nÃºmero ganador</b> durante una semana despuÃ©s del sorteo. âœ”ï¸</p>
        <div id="winning" class="winning-banner" hidden></div>
      </div>
    </section>
  </main>

  <footer>
    <small>Organiza: <b>Artemente</b>. Reglas: gana quien coincida con las 2 Ãºltimas cifras del premio mayor de la LoterÃ­a de MedellÃ­n del 7 de noviembre de 2025.</small>
  </footer>

  <script>
    // ================== CONFIGURACIÃ“N RÃPIDA ==================
    const WHATS_NUMBER = "573127302963"; // Reemplaza por tu nÃºmero de WhatsApp (con indicativo de paÃ­s)
    const SHEET_ID = "1GxjtQxIKo0Z4YMQr09dNTQRIXET-iCT-IlEldU6cXsw"; // ID de tu Google Sheet
    // ==========================================================

    const board = document.getElementById('board');
    const btnWhats = document.getElementById('btnWhats');
    const btnResetSelection = document.getElementById('btnResetSelection');

    let availableNumbers = []; // NÃºmeros disponibles segÃºn el Google Sheet
    let selectedNumbers = new Set(); // NÃºmeros que el usuario ha seleccionado en la UI

    // Cargar estado de la selecciÃ³n del usuario desde localStorage
    const loadSelectedState = () => {
      const saved = localStorage.getItem('rifa-artemente-selected');
      if (saved) {
        selectedNumbers = new Set(JSON.parse(saved));
      }
    };

    // Guardar estado de la selecciÃ³n del usuario en localStorage
    const saveSelectedState = () => {
      localStorage.setItem('rifa-artemente-selected', JSON.stringify(Array.from(selectedNumbers)));
    };

    // Generar nÃºmeros 00..99
    const allNumbers = Array.from({length:100}, (_,i)=> (""+i).padStart(2,'0'));

    async function loadAvailableNumbers() {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&tq=select%20*`;
        const res = await fetch(url, { cache: "no-store" });
        const txt = await res.text();
        const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1));
        const rows = json.table.rows;

        availableNumbers = rows
          .map(r => r.c?.[0]?.v)
          .filter(v => v !== null && v !== undefined && v !== "" && String(v).toLowerCase() !== "numero")
          .map(v => String(v).padStart(2, "0"));
        console.log("NÃºmeros disponibles cargados:", availableNumbers);
      } catch (e) {
        console.error("No se pudo cargar el Sheet:", e);
        availableNumbers = []; // Si hay un error, se inicializa como vacÃ­o
        alert("Â¡Error al cargar los nÃºmeros de la rifa! Intenta de nuevo mÃ¡s tarde o contacta al organizador.");
      }
      renderBoard(); // Renderiza el tablero una vez que los datos se han cargado
    }

    function renderBoard(){
      board.innerHTML = '';
      allNumbers.forEach(num => {
        const isAvailableInSheet = availableNumbers.includes(num);
        const isSelectedByUser = selectedNumbers.has(num);

        const cell = document.createElement('button');
        cell.className = 'cell';
        cell.setAttribute('role','gridcell');
        cell.dataset.num = num;
        cell.innerHTML = `<div>${num}</div>`;

        if (!isAvailableInSheet) {
          cell.classList.add('sold');
          cell.setAttribute('aria-label', `NÃºmero ${num} reservado`);
          cell.disabled = true; // Deshabilita los nÃºmeros ya vendidos
        } else if (isSelectedByUser) {
          cell.classList.add('selected');
          cell.setAttribute('aria-pressed', 'true');
          cell.setAttribute('aria-label', `NÃºmero ${num} seleccionado`);
        } else {
          cell.setAttribute('aria-pressed', 'false');
          cell.setAttribute('aria-label', `NÃºmero ${num} disponible para seleccionar`);
        }
        
        cell.addEventListener('click', () => {
          if (isAvailableInSheet) { // Solo permite seleccionar si el nÃºmero estÃ¡ disponible en el Sheet
            if (selectedNumbers.has(num)) {
              selectedNumbers.delete(num);
              cell.classList.remove('selected');
              cell.setAttribute('aria-pressed', 'false');
            } else {
              selectedNumbers.add(num);
              cell.classList.add('selected');
              cell.setAttribute('aria-pressed', 'true');
            }
            saveSelectedState();
            updateWhatsAppButton(); // Actualiza el botÃ³n de WhatsApp
          }
        });
        board.appendChild(cell);
      });
      updateWhatsAppButton();
    }

    // Actualizar el estado del botÃ³n de WhatsApp
    function updateWhatsAppButton() {
      if (selectedNumbers.size > 0) {
        btnWhats.textContent = `ğŸ“² Reservar ${selectedNumbers.size} NÃºmero(s)`;
        btnWhats.classList.add('ok');
        btnWhats.classList.remove('primary');
      } else {
        btnWhats.textContent = `ğŸ’¬ Consultar Disponibilidad`;
        btnWhats.classList.remove('ok');
        btnWhats.classList.add('primary'); // Estilo diferente si no hay selecciÃ³n
      }
    }

    // Evento del botÃ³n de WhatsApp
    btnWhats.onclick = () => {
      let whatsMessage;
      if (selectedNumbers.size > 0) {
        const sortedSelected = Array.from(selectedNumbers).sort(); // Ordenar nÃºmeros seleccionados
        whatsMessage = encodeURIComponent(
          `Hola ğŸ‘‹, estoy interesado en reservar los siguientes nÃºmeros para la *Rifa Artemente*: ${sortedSelected.join(', ')}. Â¿EstÃ¡n disponibles para comprarlos?`
        );
      } else {
        whatsMessage = encodeURIComponent(
          "Hola ğŸ‘‹, quiero participar en la *Rifa Artemente*: Conecta con tu EnergÃ­a Creativa. Â¿QuÃ© nÃºmeros tienes disponibles?"
        );
      }
      const url = `https://api.whatsapp.com/send?phone=${WHATS_NUMBER}&text=${whatsMessage}`;
      window.open(url, '_blank');
    };

    // BotÃ³n para limpiar la selecciÃ³n
    btnResetSelection.onclick = () => {
      if(confirm('Â¿Desea limpiar su selecciÃ³n actual de nÃºmeros?')){
        selectedNumbers.clear();
        saveSelectedState();
        renderBoard(); // Volver a renderizar para reflejar el cambio
      }
    };

    // Mostrar ganador (si se pasa en el hash #ganador=NN)
    const params = new URLSearchParams(location.hash.slice(1));
    const winnerNumber = params.get('ganador');
    if(winnerNumber){
      const formattedWinner = winnerNumber.padStart(2,'0');
      const winBox = document.getElementById('winning');
      winBox.hidden = false;
      winBox.innerHTML = `ğŸ‰ Â¡Felicidades! El nÃºmero ganador es: <b>${formattedWinner}</b>. <br>Â¡Gracias por participar!`;
    }

    // Inicia la carga de datos y el renderizado
    loadSelectedState(); // Cargar la selecciÃ³n previa del usuario
    loadAvailableNumbers(); // Cargar nÃºmeros disponibles del Sheet
  </script>

</body>
</html>