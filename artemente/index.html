<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>¡Rifa Artemente: Conecta con tu Energía Creativa!</title>
  <meta name="description" content="Rifa de un Kit Creativo-Consciente (camiseta, tula y sesión de yoga). Participa: juega el 7 de noviembre de 2025 con las 2 últimas cifras de la Lotería de Medellín. Publicaremos el número ganador aquí." />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="wrap">
      <div class="info">
        <span class="tag">¡Conecta con tu Energía Creativa!</span>
        <span class="sub">Juega el <b>7 de noviembre de 2025</b> con las <b>2 últimas cifras</b> de la Lotería de Medellín.</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <figure class="card">
        <img class="hero-img" src="artemente-rifa.jpg" alt="Kit Creativo Artemente en rifa" />
      </figure>

      <div class="grid-card card">
        <h1 class="title">Gánate este Kit Creativo-Consciente Artemente</h1>
        <p class="sub">El ganador se llevará: <b>camiseta, tula y sesión de yoga con meditación antiestrés</b>. ¡Pocos cupos disponibles y mucha suerte! <b>Valor del número: $10.000</b></p>
        
        <div class="legend" aria-hidden="true">
          <div class="legend-item"><span class="dot"></span> Disponible</div>
          <div class="legend-item"><span class="dot selected"></span> Seleccionado</div>
          <div class="legend-item"><span class="dot sold"></span> Reservado</div>
        </div>

        <div id="board" class="board" role="grid" aria-label="Cuadrícula de la rifa (00 a 99)"></div>
        
        <div class="cta">
          <button id="btnWhats" class="btn ok">📲 Enviar Selección por WhatsApp</button>
          <button id="btnResetSelection" class="btn ghost" title="Limpiar números seleccionados">Limpiar Selección</button>
        </div>
        <p class="note">Publicaremos aquí el <b>número ganador</b> durante una semana después del sorteo. ✔️</p>
        <div id="winning" class="winning-banner" hidden></div>
      </div>
    </section>
  </main>

  <footer>
    <small>Organiza: <b>Artemente</b>. Reglas: gana quien coincida con las 2 últimas cifras del premio mayor de la Lotería de Medellín del 7 de noviembre de 2025.</small>
  </footer>

  <script>
    // ================== CONFIGURACIÓN RÁPIDA ==================
    const WHATS_NUMBER = "573127302963"; // Reemplaza por tu número de WhatsApp (con indicativo de país)
    const SHEET_ID = "1GxjtQxIKo0Z4YMQr09dNTQRIXET-iCT-IlEldU6cXsw"; // ID de tu Google Sheet
    // ==========================================================

    const board = document.getElementById('board');
    const btnWhats = document.getElementById('btnWhats');
    const btnResetSelection = document.getElementById('btnResetSelection');

    let availableNumbers = []; // Números disponibles según el Google Sheet
    let selectedNumbers = new Set(); // Números que el usuario ha seleccionado en la UI

    // Cargar estado de la selección del usuario desde localStorage
    const loadSelectedState = () => {
      const saved = localStorage.getItem('rifa-artemente-selected');
      if (saved) {
        selectedNumbers = new Set(JSON.parse(saved));
      }
    };

    // Guardar estado de la selección del usuario en localStorage
    const saveSelectedState = () => {
      localStorage.setItem('rifa-artemente-selected', JSON.stringify(Array.from(selectedNumbers)));
    };

    // Generar números 00..99
    const allNumbers = Array.from({length:100}, (_,i)=> (""+i).padStart(2,'0'));

    async function loadAvailableNumbers() {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&tq=select%20*`;
        const res = await fetch(url, { cache: "no-store" });
        const txt = await res.text();
        const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1));
        const rows = json.table.rows;

        availableNumbers = rows
          .map(r => r.c?.[0]?.v)
          .filter(v => v !== null && v !== undefined && v !== "" && String(v).toLowerCase() !== "numero")
          .map(v => String(v).padStart(2, "0"));
        console.log("Números disponibles cargados:", availableNumbers);
      } catch (e) {
        console.error("No se pudo cargar el Sheet:", e);
        availableNumbers = []; // Si hay un error, se inicializa como vacío
        alert("¡Error al cargar los números de la rifa! Intenta de nuevo más tarde o contacta al organizador.");
      }
      renderBoard(); // Renderiza el tablero una vez que los datos se han cargado
    }

    function renderBoard(){
      board.innerHTML = '';
      allNumbers.forEach(num => {
        const isAvailableInSheet = availableNumbers.includes(num);
        const isSelectedByUser = selectedNumbers.has(num);

        const cell = document.createElement('button');
        cell.className = 'cell';
        cell.setAttribute('role','gridcell');
        cell.dataset.num = num;
        cell.innerHTML = `<div>${num}</div>`;

        if (!isAvailableInSheet) {
          cell.classList.add('sold');
          cell.setAttribute('aria-label', `Número ${num} reservado`);
          cell.disabled = true; // Deshabilita los números ya vendidos
        } else if (isSelectedByUser) {
          cell.classList.add('selected');
          cell.setAttribute('aria-pressed', 'true');
          cell.setAttribute('aria-label', `Número ${num} seleccionado`);
        } else {
          cell.setAttribute('aria-pressed', 'false');
          cell.setAttribute('aria-label', `Número ${num} disponible para seleccionar`);
        }
        
        cell.addEventListener('click', () => {
          if (isAvailableInSheet) { // Solo permite seleccionar si el número está disponible en el Sheet
            if (selectedNumbers.has(num)) {
              selectedNumbers.delete(num);
              cell.classList.remove('selected');
              cell.setAttribute('aria-pressed', 'false');
            } else {
              selectedNumbers.add(num);
              cell.classList.add('selected');
              cell.setAttribute('aria-pressed', 'true');
            }
            saveSelectedState();
            updateWhatsAppButton(); // Actualiza el botón de WhatsApp
          }
        });
        board.appendChild(cell);
      });
      updateWhatsAppButton();
    }

    // Actualizar el estado del botón de WhatsApp
    function updateWhatsAppButton() {
      if (selectedNumbers.size > 0) {
        btnWhats.textContent = `📲 Reservar ${selectedNumbers.size} Número(s)`;
        btnWhats.classList.add('ok');
        btnWhats.classList.remove('primary');
      } else {
        btnWhats.textContent = `💬 Consultar Disponibilidad`;
        btnWhats.classList.remove('ok');
        btnWhats.classList.add('primary'); // Estilo diferente si no hay selección
      }
    }

    // Evento del botón de WhatsApp
    btnWhats.onclick = () => {
      let whatsMessage;
      if (selectedNumbers.size > 0) {
        const sortedSelected = Array.from(selectedNumbers).sort(); // Ordenar números seleccionados
        whatsMessage = encodeURIComponent(
          `Hola 👋, estoy interesado en reservar los siguientes números para la *Rifa Artemente*: ${sortedSelected.join(', ')}. ¿Están disponibles para comprarlos?`
        );
      } else {
        whatsMessage = encodeURIComponent(
          "Hola 👋, quiero participar en la *Rifa Artemente*: Conecta con tu Energía Creativa. ¿Qué números tienes disponibles?"
        );
      }
      const url = `https://api.whatsapp.com/send?phone=${WHATS_NUMBER}&text=${whatsMessage}`;
      window.open(url, '_blank');
    };

    // Botón para limpiar la selección
    btnResetSelection.onclick = () => {
      if(confirm('¿Desea limpiar su selección actual de números?')){
        selectedNumbers.clear();
        saveSelectedState();
        renderBoard(); // Volver a renderizar para reflejar el cambio
      }
    };

    // Mostrar ganador (si se pasa en el hash #ganador=NN)
    const params = new URLSearchParams(location.hash.slice(1));
    const winnerNumber = params.get('ganador');
    if(winnerNumber){
      const formattedWinner = winnerNumber.padStart(2,'0');
      const winBox = document.getElementById('winning');
      winBox.hidden = false;
      winBox.innerHTML = `🎉 ¡Felicidades! El número ganador es: <b>${formattedWinner}</b>. <br>¡Gracias por participar!`;
    }

    // Inicia la carga de datos y el renderizado
    loadSelectedState(); // Cargar la selección previa del usuario
    loadAvailableNumbers(); // Cargar números disponibles del Sheet
  </script>

</body>
</html>